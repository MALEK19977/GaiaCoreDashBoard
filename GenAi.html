<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisation des Données Sus_DW avec IA</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .file-input {
            margin-bottom: 20px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .visualization {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-container {
            flex: 1 1 400px;
            min-height: 300px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .ai-analysis {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        
        .ai-prompt {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .ai-response {
            margin-top: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .summary-card h4 {
            margin-top: 0;
            color: #7f8c8d;
        }
        
        .summary-card p {
            font-size: 24px;
            margin: 10px 0 0;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Visualisation des Données Sus_DW avec IA</h1>
        
        <div class="file-input">
            <h2>Importer le fichier SQL</h2>
            <input type="file" id="sqlFile" accept=".sql">
            <button id="importBtn">Importer les données</button>
            <div id="status" class="status"></div>
        </div>
        
        <div id="dataPreview" class="container" style="display: none;">
            <div class="tabs">
                <div class="tab active" data-tab="preview">Aperçu</div>
                <div class="tab" data-tab="summary">Résumé</div>
                <div class="tab" data-tab="analysis">Analyse IA</div>
            </div>
            
            <div class="tab-content active" id="previewTab">
                <h3>Aperçu des Données</h3>
                <div id="tableContainer"></div>
            </div>
            
            <div class="tab-content" id="summaryTab">
                <h3>Résumé des Données</h3>
                <div class="data-summary" id="dataSummary"></div>
                <div id="autoAnalysis"></div>
            </div>
            
            <div class="tab-content" id="analysisTab">
                <h3>Analyse par IA</h3>
                <div class="ai-analysis">
                    <h4>Demander une analyse à l'IA</h4>
                    <textarea class="ai-prompt" id="aiPrompt" rows="3" placeholder="Posez une question ou demandez une analyse des données..."></textarea>
                    <button id="askAI">Demander à l'IA</button>
                    <div class="ai-response" id="aiResponse">
                        <p>La réponse de l'IA apparaîtra ici...</p>
                    </div>
                </div>
                
                <div class="ai-analysis">
                    <h4>Suggestions rapides</h4>
                    <button class="ai-suggestion" data-prompt="Identifie les tendances principales dans ces données">Tendances principales</button>
                    <button class="ai-suggestion" data-prompt="Quelles anomalies ou valeurs aberrantes peux-tu détecter ?">Détecter anomalies</button>
                    <button class="ai-suggestion" data-prompt="Fais des recommandations basées sur ces données">Recommandations</button>
                    <button class="ai-suggestion" data-prompt="Résume les insights clés en 3 points">Insights clés</button>
                </div>
            </div>
        </div>
        
        <div id="visualizations" class="visualization" style="display: none;">
            <h2>Visualisations</h2>
            
            <div class="chart-container">
                <h3>Température par Ville</h3>
                <canvas id="tempChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Niveau de CO2 par Ville</h3>
                <canvas id="co2Chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Humidité Moyenne</h3>
                <canvas id="humidityChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Vitesse du Vent</h3>
                <canvas id="windChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('sqlFile');
            const importBtn = document.getElementById('importBtn');
            const statusDiv = document.getElementById('status');
            const dataPreview = document.getElementById('dataPreview');
            const visualizations = document.getElementById('visualizations');
            const tableContainer = document.getElementById('tableContainer');
            const dataSummary = document.getElementById('dataSummary');
            const autoAnalysis = document.getElementById('autoAnalysis');
            const aiPrompt = document.getElementById('aiPrompt');
            const askAI = document.getElementById('askAI');
            const aiResponse = document.getElementById('aiResponse');
            
            let parsedData = [];
            
            // Gestion des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Suggestions IA
            document.querySelectorAll('.ai-suggestion').forEach(button => {
                button.addEventListener('click', function() {
                    aiPrompt.value = this.getAttribute('data-prompt');
                });
            });
            
            importBtn.addEventListener('click', function() {
                const file = fileInput.files[0];
                if (!file) {
                    showStatus('Veuillez sélectionner un fichier SQL', 'error');
                    return;
                }
                
                showStatus('Traitement du fichier en cours... <span class="loading"></span>', '');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const copyStart = content.indexOf('COPY public.dim_climat');
                        if (copyStart === -1) {
                            throw new Error('Table dim_climat non trouvée dans le fichier SQL');
                        }
                        
                        const copyEnd = content.indexOf('\n\\.', copyStart);
                        if (copyEnd === -1) {
                            throw new Error('Fin de section COPY non trouvée');
                        }
                        
                        const copyContent = content.slice(copyStart, copyEnd);
                        const dataLines = copyContent.split('\n').slice(1);
                        
                        parsedData = dataLines.map(line => {
                            const cleanLine = line.trim();
                            if (!cleanLine) return null;
                            
                            const parts = cleanLine.split('\t');
                            if (parts.length < 7) return null;
                            
                            return {
                                id: parts[0],
                                location: parts[1],
                                date: parts[2],
                                temperature: parseFloat(parts[3]) || parts[3],
                                humidity: parts[4] !== '\\N' ? parts[4] : null,
                                windSpeed: parseFloat(parts[5]) || 0,
                                co2Level: parseFloat(parts[6]) || 0
                            };
                        }).filter(item => item !== null);
                        
                        showStatus('Fichier importé avec succès! ' + parsedData.length + ' enregistrements trouvés.', 'success');
                        showDataPreview();
                        showDataSummary();
                        showVisualizations();
                        generateAutoAnalysis();
                    } catch (error) {
                        showStatus('Erreur lors du traitement du fichier: ' + error.message, 'error');
                        console.error(error);
                    }
                };
                reader.onerror = function() {
                    showStatus('Erreur lors de la lecture du fichier', 'error');
                };
                reader.readAsText(file);
            });
            
            askAI.addEventListener('click', function() {
                const prompt = aiPrompt.value.trim();
                if (!prompt) {
                    aiResponse.innerHTML = '<p>Veuillez entrer une question ou une demande d\'analyse.</p>';
                    return;
                }
                
                aiResponse.innerHTML = '<p><span class="loading"></span> L\'IA analyse les données...</p>';
                
                // Simulation d'une réponse IA (en production, vous utiliseriez une API comme OpenAI)
                setTimeout(() => {
                    const response = generateAIResponse(prompt, parsedData);
                    aiResponse.innerHTML = `<p><strong>Question:</strong> ${prompt}</p><div>${response}</div>`;
                }, 1500);
            });
            
            function showStatus(message, type) {
                statusDiv.innerHTML = message;
                statusDiv.className = 'status ' + type;
            }
            
            function showDataPreview() {
                let tableHTML = '<table><tr><th>ID</th><th>Location</th><th>Date</th><th>Température</th><th>Humidité</th><th>Vitesse Vent</th><th>CO2</th></tr>';
                
                const previewItems = parsedData.slice(0, 10);
                
                previewItems.forEach(item => {
                    tableHTML += `<tr>
                        <td>${item.id}</td>
                        <td>${item.location}</td>
                        <td>${item.date}</td>
                        <td>${item.temperature}</td>
                        <td>${item.humidity || 'N/A'}</td>
                        <td>${item.windSpeed}</td>
                        <td>${item.co2Level}</td>
                    </tr>`;
                });
                
                tableHTML += '</table>';
                tableContainer.innerHTML = tableHTML;
                dataPreview.style.display = 'block';
            }
            
            function showDataSummary() {
                const locations = [...new Set(parsedData.map(item => item.location))];
                const dates = parsedData.map(item => new Date(item.date));
                const minDate = new Date(Math.min(...dates.filter(d => !isNaN(d))));
                const maxDate = new Date(Math.max(...dates.filter(d => !isNaN(d))));
                
                const temps = parsedData.map(item => {
                    const temp = parseFloat(item.temperature);
                    return isNaN(temp) ? null : temp;
                }).filter(temp => temp !== null);
                
                const avgTemp = temps.length ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(2) : 'N/A';
                
                dataSummary.innerHTML = `
                    <div class="summary-card">
                        <h4>Villes</h4>
                        <p>${locations.length}</p>
                    </div>
                    <div class="summary-card">
                        <h4>Période</h4>
                        <p>${isNaN(minDate) ? 'N/A' : minDate.toLocaleDateString()} - ${isNaN(maxDate) ? 'N/A' : maxDate.toLocaleDateString()}</p>
                    </div>
                    <div class="summary-card">
                        <h4>Enregistrements</h4>
                        <p>${parsedData.length}</p>
                    </div>
                    <div class="summary-card">
                        <h4>Temp. Moyenne</h4>
                        <p>${avgTemp} °C</p>
                    </div>
                `;
            }
            
            function generateAutoAnalysis() {
                // Analyse automatique des données
                const locations = [...new Set(parsedData.map(item => item.location))];
                const locationStats = {};
                
                locations.forEach(loc => {
                    const locData = parsedData.filter(item => item.location === loc);
                    const temps = locData.map(item => {
                        const temp = parseFloat(item.temperature);
                        return isNaN(temp) ? null : temp;
                    }).filter(temp => temp !== null);
                    
                    const co2s = locData.map(item => item.co2Level).filter(co2 => !isNaN(co2));
                    const humidities = locData.map(item => {
                        const hum = parseFloat(item.humidity);
                        return isNaN(hum) ? null : hum;
                    }).filter(hum => hum !== null);
                    const winds = locData.map(item => item.windSpeed).filter(ws => !isNaN(ws));
                    
                    locationStats[loc] = {
                        avgTemp: temps.length ? (temps.reduce((a, b) => a + b, 0) / temps.length) : 0,
                        avgCo2: co2s.length ? (co2s.reduce((a, b) => a + b, 0) / co2s.length) : 0,
                        avgHumidity: humidities.length ? (humidities.reduce((a, b) => a + b, 0) / humidities.length) : 0,
                        avgWind: winds.length ? (winds.reduce((a, b) => a + b, 0) / winds.length) : 0
                    };
                });
                
                // Trouver les extrêmes
                let maxTempLoc = '', maxTemp = -Infinity;
                let minTempLoc = '', minTemp = Infinity;
                let maxCo2Loc = '', maxCo2 = -Infinity;
                
                for (const loc in locationStats) {
                    if (locationStats[loc].avgTemp > maxTemp) {
                        maxTemp = locationStats[loc].avgTemp;
                        maxTempLoc = loc;
                    }
                    if (locationStats[loc].avgTemp < minTemp) {
                        minTemp = locationStats[loc].avgTemp;
                        minTempLoc = loc;
                    }
                    if (locationStats[loc].avgCo2 > maxCo2) {
                        maxCo2 = locationStats[loc].avgCo2;
                        maxCo2Loc = loc;
                    }
                }
                
                // Générer l'analyse automatique
                const analysis = `
                    <h4>Analyse Automatique</h4>
                    <ul>
                        <li>La ville la plus chaude en moyenne est <strong>${maxTempLoc}</strong> avec ${maxTemp.toFixed(2)}°C</li>
                        <li>La ville la plus froide en moyenne est <strong>${minTempLoc}</strong> avec ${minTemp.toFixed(2)}°C</li>
                        <li>La ville avec le niveau de CO2 moyen le plus élevé est <strong>${maxCo2Loc}</strong> avec ${maxCo2.toFixed(2)} ppm</li>
                        ${maxCo2 > 400 ? '<li class="warning">Attention: Le niveau de CO2 moyen dépasse le seuil recommandé de 400 ppm dans certaines villes</li>' : ''}
                    </ul>
                    <p>Utilisez l'onglet "Analyse IA" pour des insights plus approfondis.</p>
                `;
                
                autoAnalysis.innerHTML = analysis;
            }
            
            function showVisualizations() {
                const locations = [...new Set(parsedData.map(item => item.location))];
                const locationStats = {};
                
                locations.forEach(loc => {
                    const locData = parsedData.filter(item => item.location === loc);
                    const temps = locData.map(item => {
                        const temp = parseFloat(item.temperature);
                        return isNaN(temp) ? null : temp;
                    }).filter(temp => temp !== null);
                    
                    const co2s = locData.map(item => item.co2Level).filter(co2 => !isNaN(co2));
                    const humidities = locData.map(item => {
                        const hum = parseFloat(item.humidity);
                        return isNaN(hum) ? null : hum;
                    }).filter(hum => hum !== null);
                    const winds = locData.map(item => item.windSpeed).filter(ws => !isNaN(ws));
                    
                    locationStats[loc] = {
                        avgTemp: temps.length ? (temps.reduce((a, b) => a + b, 0) / temps.length) : 0,
                        avgCo2: co2s.length ? (co2s.reduce((a, b) => a + b, 0) / co2s.length) : 0,
                        avgHumidity: humidities.length ? (humidities.reduce((a, b) => a + b, 0) / humidities.length) : 0,
                        avgWind: winds.length ? (winds.reduce((a, b) => a + b, 0) / winds.length) : 0
                    };
                });
                
                createChart('tempChart', 'Température Moyenne (°C)', locations, 
                           locations.map(loc => locationStats[loc].avgTemp), 'rgba(255, 99, 132, 0.6)');
                
                createChart('co2Chart', 'Niveau de CO2 Moyen (ppm)', locations, 
                           locations.map(loc => locationStats[loc].avgCo2), 'rgba(54, 162, 235, 0.6)');
                
                createChart('humidityChart', 'Humidité Moyenne (%)', locations, 
                           locations.map(loc => locationStats[loc].avgHumidity), 'rgba(75, 192, 192, 0.6)');
                
                createChart('windChart', 'Vitesse Moyenne du Vent (km/h)', locations, 
                           locations.map(loc => locationStats[loc].avgWind), 'rgba(153, 102, 255, 0.6)');
                
                visualizations.style.display = 'block';
            }
            
            function createChart(canvasId, label, labels, data, backgroundColor) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: backgroundColor,
                            borderColor: backgroundColor.replace('0.6', '1'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // Fonction de simulation d'IA (remplacer par un appel à une vraie API IA en production)
            function generateAIResponse(prompt, data) {
                // Analyse simple basée sur le prompt
                if (prompt.toLowerCase().includes('tendance')) {
                    return `
                        <p><strong>Analyse des tendances :</strong></p>
                        <p>Les données montrent des variations significatives entre les différentes villes :</p>
                        <ul>
                            <li>Les températures les plus élevées sont généralement enregistrées à Sfax</li>
                            <li>Les niveaux de CO2 varient considérablement, avec des pics dans les zones urbaines denses</li>
                            <li>Une corrélation semble exister entre les températures élevées et les niveaux de CO2</li>
                        </ul>
                        <p>Recommandation : Une analyse plus approfondie des causes de ces variations pourrait être utile.</p>
                    `;
                } else if (prompt.toLowerCase().includes('anomal') || prompt.toLowerCase().includes('aberrant')) {
                    return `
                        <p><strong>Détection d'anomalies :</strong></p>
                        <p>Plusieurs points méritent attention :</p>
                        <ul>
                            <li>Certaines valeurs de température extrêmes (au-dessus de 1000°C) semblent être des erreurs de saisie</li>
                            <li>Des valeurs manquantes (NULL) sont présentes dans les données d'humidité</li>
                            <li>Certaines dates semblent mal formatées (ex: 2024/10/21 au lieu de 2024-10-21)</li>
                        </ul>
                        <p>Recommandation : Nettoyer les données avant toute analyse approfondie.</p>
                    `;
                } else if (prompt.toLowerCase().includes('recommandation')) {
                    return `
                        <p><strong>Recommandations basées sur les données :</strong></p>
                        <ol>
                            <li><strong>Surveillance accrue</strong> : Mettre en place un système de surveillance en temps réel pour les villes avec des niveaux de CO2 élevés</li>
                            <li><strong>Vérification des données</strong> : Auditer les capteurs dans les zones avec des valeurs aberrantes</li>
                            <li><strong>Actions correctives</strong> : Envisager des mesures pour réduire les émissions dans les zones critiques</li>
                            <li><strong>Analyse complémentaire</strong> : Croiser ces données avec d'autres indicateurs (trafic, industrie) pour mieux comprendre les causes</li>
                        </ol>
                    `;
                } else {
                    // Réponse générique
                    return `
                        <p><strong>Analyse générale des données climatiques :</strong></p>
                        <p>Les données couvrent ${[...new Set(parsedData.map(item => item.location))].length} villes principales avec des mesures de température, humidité, vitesse du vent et niveaux de CO2.</p>
                        <p>Points clés :</p>
                        <ul>
                            <li>La température moyenne globale est d'environ ${calculateAverage(parsedData.map(item => parseFloat(item.temperature) || 0))}°C</li>
                            <li>Le niveau moyen de CO2 est de ${calculateAverage(parsedData.map(item => item.co2Level))} ppm</li>
                            <li>${countMissingValues(parsedData, 'humidity')} valeurs manquantes pour l'humidité</li>
                        </ul>
                        <p>Pour une analyse plus spécifique, veuillez poser une question plus précise.</p>
                    `;
                }
            }
            
            // Fonctions utilitaires pour l'IA
            function calculateAverage(values) {
                const validValues = values.filter(v => !isNaN(v));
                return validValues.length ? (validValues.reduce((a, b) => a + b, 0) / validValues.length).toFixed(2) : 'N/A';
            }
            
            function countMissingValues(data, field) {
                return data.filter(item => item[field] === null || item[field] === '\\N').length;
            }
        });
    </script>
</body>
</html>